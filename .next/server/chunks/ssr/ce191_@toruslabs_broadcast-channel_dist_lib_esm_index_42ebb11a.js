module.exports=[15133,a=>{"use strict";let b;var c=a.i(44002);Promise.resolve(!1),Promise.resolve(!0);let d=Promise.resolve();function e(a,b){return a||(a=0),new Promise(c=>{setTimeout(()=>c(b),a)})}function f(){return Math.random().toString(36).substring(2)}let g=0;function h(){let a=1e3*Date.now();return a<=g&&(a=g+1),g=a,a}let i=c.default.getLogger("broadcast-channel");i.setLevel("error");class j{ttl;map=new Map;_to=!1;constructor(a){this.ttl=a}has(a){return this.map.has(a)}add(a){this.map.set(a,k()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,function(a){let b=k()-a.ttl,c=a.map[Symbol.iterator]();for(;;){let d=c.next().value;if(!d)return;let e=d[0];if(!(d[1]<b))return;a.map.delete(e)}}(this)},0))}clear(){this.map.clear()}}function k(){return Date.now()}function l(a={}){let b=JSON.parse(JSON.stringify(a));return void 0===b.webWorkerSupport&&(b.webWorkerSupport=!0),b.idb||(b.idb={}),b.idb.ttl||(b.idb.ttl=45e3),b.idb.fallbackInterval||(b.idb.fallbackInterval=150),a.idb&&"function"==typeof a.idb.onclose&&(b.idb.onclose=a.idb.onclose),b.localstorage||(b.localstorage={}),b.localstorage.removeTimeout||(b.localstorage.removeTimeout=6e4),b.server||(b.server={}),b.server.api_url||(b.server.api_url="https://api.web3auth.io/session-service/v2"),b.server.socket_url||(b.server.socket_url="https://session.web3auth.io"),b.server.removeTimeout||(b.server.removeTimeout=3e5),a.methods&&(b.methods=a.methods),b}let m="messages",n={durability:"relaxed"};function o(){return"undefined"!=typeof indexedDB&&indexedDB}function p(a){a.commit&&a.commit()}function q(a){let b=o();if(!b)return Promise.reject(Error("IndexedDB not available"));let c=b.open("pubkey.broadcast-channel-0-"+a);return c.onupgradeneeded=a=>{a.target.result.createObjectStore(m,{keyPath:"id",autoIncrement:!0})},new Promise((a,b)=>{c.onerror=a=>b(a),c.onsuccess=()=>{a(c.result)}})}function r(a,b,c){let d={uuid:b,time:Date.now(),data:c},e=a.transaction([m],"readwrite",n);return new Promise((a,b)=>{e.oncomplete=()=>a(),e.onerror=a=>b(a),e.objectStore(m).add(d),p(e)})}function s(a){let b=a.transaction(m,"readonly",n),c=b.objectStore(m),d=[];return new Promise(a=>{c.openCursor().onsuccess=c=>{let e=c.target.result;e?(d.push(e.value),e.continue()):(p(b),a(d))}})}function t(a,b){let c=a.transaction(m,"readonly",n),d=c.objectStore(m),e=[],f=IDBKeyRange.bound(b+1,1/0);if(d.getAll){let a=d.getAll(f);return new Promise((b,c)=>{a.onerror=a=>c(a),a.onsuccess=function(a){b(a.target.result)}})}return new Promise((a,g)=>{let h=function(){try{return f=IDBKeyRange.bound(b+1,1/0),d.openCursor(f)}catch{return d.openCursor()}}();h.onerror=a=>g(a),h.onsuccess=d=>{let f=d.target.result;f?f.value.id<b+1?f.continue(b+1):(e.push(f.value),f.continue()):(p(c),a(e))}})}function u(a,b){let c=a.transaction([m],"readwrite",n).objectStore(m);return Promise.all(b.map(a=>{let b=c.delete(a);return new Promise(a=>{b.onsuccess=()=>a()})}))}function v(a,b){let c=Date.now()-b,d=a.transaction(m,"readonly",n),e=d.objectStore(m),f=[];return new Promise(a=>{e.openCursor().onsuccess=b=>{let e=b.target.result;if(e){let b=e.value;b.time<c?(f.push(b),e.continue()):(p(d),a(f))}else a(f)}})}function w(a,b){return v(a,b).then(b=>u(a,b.map(a=>a.id)))}function x(a,b){return b=l(b),q(a).then(c=>{let g={closed:!1,lastCursorId:0,channelName:a,options:b,uuid:f(),eMIs:new j(2*b.idb.ttl),writeBlockPromise:d,messagesCallback:null,readQueuePromises:[],db:c,time:h()};return c.onclose=function(){g.closed=!0,b.idb.onclose&&b.idb.onclose()},function a(b){b.closed||y(b).then(()=>e(b.options.idb.fallbackInterval)).then(()=>a(b)).catch(a=>{throw a})}(g),g})}function y(a){return a.closed||!a.messagesCallback?d:t(a.db,a.lastCursorId).then(b=>(b.filter(a=>!!a).map(b=>(b.id>a.lastCursorId&&(a.lastCursorId=b.id),b)).filter(b=>!(b.uuid===a.uuid||a.eMIs.has(b.id))&&!(b.data.time<a.messagesCallbackTime)).sort((a,b)=>a.time-b.time).forEach(b=>{a.messagesCallback&&(a.eMIs.add(b.id),a.messagesCallback(b.data))}),d))}function z(a){a.closed=!0,a.db.close()}function A(a,b){return a.writeBlockPromise=a.writeBlockPromise.then(()=>r(a.db,a.uuid,b)).then(()=>(0===Math.floor(11*Math.random()+0)&&w(a.db,a.options.idb.ttl),d)),a.writeBlockPromise}function B(a,b,c){a.messagesCallbackTime=c,a.messagesCallback=b,y(a)}function C(){return!!o()}function D(a){return 2*a.idb.fallbackInterval}a.s(["TRANSACTION_SETTINGS",()=>n,"averageResponseTime",()=>D,"canBeUsed",()=>C,"cleanOldMessages",()=>w,"close",()=>z,"commitIndexedDBTransaction",()=>p,"create",()=>x,"createDatabase",()=>q,"getAllMessages",()=>s,"getIdb",()=>o,"getMessagesHigherThan",()=>t,"getOldMessages",()=>v,"microSeconds",()=>h,"onMessage",()=>B,"postMessage",()=>A,"removeMessagesById",()=>u,"type",()=>"idb","writeMessage",()=>r],1621);var E=a.i(1621);let F="localstorage";function G(){return null}function H(a){return"pubkey.broadcastChannel-"+a}function I(a,b){return new Promise((c,d)=>{e().then(()=>{var d;let e=H(a.channelName),g=JSON.stringify({token:f(),time:Date.now(),data:b,uuid:a.uuid});null==(d=G())||d.setItem(e,g);let h=document.createEvent("StorageEvent");h.initStorageEvent("storage",!0,!0,e,null,g,"",null),window.dispatchEvent(h),c()}).catch(d)})}function J(a,b){let c=H(a),d=a=>{a.key===c&&a.newValue&&b(JSON.parse(a.newValue))};return window.addEventListener("storage",d),d}function K(a){window.removeEventListener("storage",a)}function L(){let a=G();if(!a)return!1;try{let b="__broadcastchannel_check";a.setItem(b,"works"),a.removeItem(b)}catch{return!1}return!0}function M(a,b){let c=l(b);if(!L())throw Error("BroadcastChannel: localstorage cannot be used");let d=f(),e=new j(c.localstorage.removeTimeout),g={channelName:a,uuid:d,time:h(),eMIs:e};return g.listener=J(a,a=>{!g.messagesCallback||a.uuid===d||!a.token||e.has(a.token)||a.data.time&&a.data.time<(g.messagesCallbackTime||0)||(e.add(a.token),g.messagesCallback(a.data))}),g}function N(a){a.listener&&K(a.listener)}function O(a,b,c){a.messagesCallbackTime=c,a.messagesCallback=b}function P(){let a=navigator.userAgent.toLowerCase();return a.includes("safari")&&!a.includes("chrome")?240:120}a.s(["addStorageEventListener",()=>J,"averageResponseTime",()=>P,"canBeUsed",()=>L,"close",()=>N,"create",()=>M,"getLocalStorage",()=>G,"microSeconds",()=>h,"onMessage",()=>O,"postMessage",()=>I,"removeStorageEventListener",()=>K,"storageKey",()=>H,"type",()=>F],43527);var Q=a.i(43527);let R="native";function S(a){let b={time:h(),messagesCallback:null,bc:new BroadcastChannel(a),subFns:[]};return b.bc.onmessage=a=>{b.messagesCallback&&b.messagesCallback(a.data)},b}function T(a){a.bc.close(),a.subFns=[]}function U(a,b){try{return a.bc.postMessage(b),d}catch(a){return Promise.reject(a)}}function V(a,b){a.messagesCallback=b}function W(){return!1}function X(){return 150}a.s(["averageResponseTime",()=>X,"canBeUsed",()=>W,"close",()=>T,"create",()=>S,"microSeconds",()=>h,"onMessage",()=>V,"postMessage",()=>U,"type",()=>R],62558);var Y=a.i(62558),Z=a.i(6677),$=a.i(77035),_=a.i(62012),aa=a.i(83915);let ab="server",ac=null,ad=new Set;function ae(a){return"pubkey.broadcastChannel-"+a}function af(a,b){return new Promise((c,d)=>{e().then(async()=>{let e=ae(a.channelName),g=(0,$.keccak256)(Buffer.from(e,"utf8")),h=await (0,_.encryptData)(g.toString("hex"),{token:f(),time:Date.now(),data:b,uuid:a.uuid}),i={allowedOrigin:a.server.allowed_origin,sameIpCheck:!0,key:(0,Z.getPublic)(g).toString("hex"),data:h,signature:(await (0,Z.sign)(g,(0,$.keccak256)(Buffer.from(h,"utf8")))).toString("hex")};return a.timeout&&(i.timeout=a.timeout),fetch(`${a.server.api_url}/channel/set`,{method:"POST",body:JSON.stringify(i),headers:{"Content-Type":"application/json; charset=utf-8"}}).then(c).catch(d)}).catch(d)})}function ag(a){if(ac)return ac;let b=(0,aa.io)(a,{transports:["websocket","polling"],withCredentials:!0,reconnectionDelayMax:1e4,reconnectionAttempts:10});return b.on("connect_error",a=>{b.io.opts.transports=["polling","websocket"],i.error("connect error",a)}),b.on("connect",async()=>{let{engine:a}=b.io;i.debug("initially connected to",a.transport.name),a.once("upgrade",()=>{i.debug("upgraded",a.transport.name)}),a.once("close",a=>{i.debug("connection closed",a)})}),b.on("error",a=>{i.error("socket errored",a),b.disconnect()}),ac=b,b}function ah(a,b,c){let d=ag(a),e=ae(b.channelName),f=(0,$.keccak256)(Buffer.from(e,"utf8")),g=(0,Z.getPublic)(f).toString("hex");d.connected?d.emit("v2:check_auth_status",g,{sameIpCheck:!0,allowedOrigin:b.server.allowed_origin}):d.once("connect",()=>{i.debug("connected with socket"),d.emit("v2:check_auth_status",g,{sameIpCheck:!0,allowedOrigin:b.server.allowed_origin})});let h=()=>{d.once("connect",async()=>{ad.has(b.channelName)&&d.emit("v2:check_auth_status",g,{sameIpCheck:!0,allowedOrigin:b.server.allowed_origin})})},j=()=>{d&&ad.has(b.channelName)?d.connected||"visible"!==document.visibilityState||h():document.removeEventListener("visibilitychange",j)},k=async a=>{try{let b=await (0,_.decryptData)(f.toString("hex"),a);i.info(b),c(b)}catch(a){i.error(a)}};return d.on("disconnect",()=>{i.debug("socket disconnected"),ad.has(b.channelName)&&(i.error("socket disconnected unexpectedly, reconnecting socket"),h())}),d.on(`${g}_success`,k),"undefined"!=typeof document&&document.addEventListener("visibilitychange",j),d}function ai(){ac&&ac.disconnect()}function aj(){return!0}function ak(a,b){b=l(b);let c={channelName:a,uuid:f(),eMIs:new j(b.server.removeTimeout),server:{api_url:b.server.api_url,socket_url:b.server.socket_url,allowed_origin:b.server.allowed_origin},time:h()};return b.server.timeout&&(c.timeout=b.server.timeout),ah(b.server.socket_url,c,a=>{!c.messagesCallback||a.uuid===c.uuid||!a.token||c.eMIs.has(a.token)||(c.eMIs.add(a.token),c.messagesCallback(a.data))}),ad.add(a),c}function al(a){ad.delete(a.channelName)}function am(a,b,c){a.messagesCallbackTime=c,a.messagesCallback=b}function an(){return 500}a.s(["averageResponseTime",()=>an,"canBeUsed",()=>aj,"close",()=>al,"create",()=>ak,"getSocketInstance",()=>ag,"microSeconds",()=>h,"onMessage",()=>am,"postMessage",()=>af,"removeStorageEventListener",()=>ai,"setupSocketConnection",()=>ah,"storageKey",()=>ae,"type",()=>ab],94186);var ao=a.i(94186);a.s([],18330),a.i(18330);var ap=a.i(41415);let aq="simulate",ar=new Set;function as(a){let b={time:h(),name:a,messagesCallback:null};return ar.add(b),b}function at(a){ar.delete(a)}function au(a,b){return new Promise(c=>{setTimeout(()=>{Array.from(ar).forEach(c=>{c.name===a.name&&c!==a&&c.messagesCallback&&c.time<b.time&&c.messagesCallback(b)}),c()},5)})}function av(a,b){a.messagesCallback=b}function aw(){return!0}function ax(){return 5}a.s(["SIMULATE_DELAY_TIME",()=>5,"averageResponseTime",()=>ax,"canBeUsed",()=>aw,"close",()=>at,"create",()=>as,"microSeconds",()=>h,"onMessage",()=>av,"postMessage",()=>au,"type",()=>aq],8563);var ay=a.i(8563);let az=[Y,E,Q,ao];function aA(a){let b=[].concat(a.methods||[],az).filter(Boolean);if(a.type){if("simulate"===a.type)return ay;let c=b.find(b=>b.type===a.type);if(c)return c;throw Error(`method-type ${a.type} not found`)}a.webWorkerSupport||(b=b.filter(a=>"idb"!==a.type));let c=b.find(b=>b.canBeUsed(a));if(c)return c;throw Error(`No useable method found in ${JSON.stringify(az.map(a=>a.type))}`)}function aB(a){b=a}let aC=new Set,aD=0;class aE{constructor(a,c){(0,ap.default)(this,"id",void 0),(0,ap.default)(this,"name",void 0),(0,ap.default)(this,"options",void 0),(0,ap.default)(this,"method",void 0),(0,ap.default)(this,"closed",void 0),(0,ap.default)(this,"_addEL",void 0),(0,ap.default)(this,"_prepP",void 0),(0,ap.default)(this,"_state",void 0),(0,ap.default)(this,"_uMP",void 0),(0,ap.default)(this,"_iL",void 0),(0,ap.default)(this,"_onML",void 0),(0,ap.default)(this,"_befC",void 0),this.id=aD++,aC.add(this),this.name=a,b&&(c=b),this.options=l(c||{}),this.method=aA(this.options),this.closed=!1,this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,function(a){let b=a.method.create(a.name,a.options);(b&&"function"==typeof b.then?0:1)?a._state=b:(a._prepP=b,b.then(b=>(a._state=b,b)).catch(a=>{throw a}))}(this)}get type(){return this.method.type}get isClosed(){return this.closed}set onmessage(a){let b={time:this.method.microSeconds(),fn:a};aI(this,"message",this._onML),a&&"function"==typeof a?(this._onML=b,aH(this,"message",b)):this._onML=null}postMessage(a){if(this.closed)throw Error(`BroadcastChannel.postMessage(): Cannot post message after channel has closed ${JSON.stringify(a)}`);return aF(this,"message",a)}postInternal(a){return aF(this,"internal",a)}addEventListener(a,b){aH(this,a,{time:this.method.microSeconds(),fn:b})}removeEventListener(a,b){let c=this._addEL[a].find(a=>a.fn===b);aI(this,a,c)}close(){if(this.closed)return Promise.resolve();aC.delete(this),this.closed=!0;let a=this._prepP?this._prepP:d;return this._onML=null,this._addEL.message=[],a.then(()=>Promise.all(Array.from(this._uMP))).then(()=>Promise.all(this._befC.map(a=>a()))).then(()=>this.method.close?this.method.close(this._state):d)}}function aF(a,b,c){let e={time:a.method.microSeconds(),type:b,data:c};return(a._prepP?a._prepP:d).then(()=>{let b=a.method.postMessage(a._state,e);return a._uMP.add(b),b.catch(()=>{}).then(()=>a._uMP.delete(b)),b})}function aG(a){return!!(a._addEL.message.length>0)||!!(a._addEL.internal.length>0)}function aH(a,b,c){a._addEL[b].push(c);if(!a._iL&&aG(a)){let b=b=>{a._addEL[b.type].forEach(c=>{b.time>=c.time?c.fn(b.data):"server"===a.method.type&&c.fn(b.data)})},c=a.method.microSeconds();a._prepP?a._prepP.then(()=>(a._iL=!0,a.method.onMessage(a._state,b,c),!0)).catch(a=>{throw a}):(a._iL=!0,a.method.onMessage(a._state,b,c))}}function aI(a,b,c){if(c){a._addEL[b]=a._addEL[b].filter(a=>a!==c);if(a._iL&&!aG(a)){a._iL=!1;let b=a.method.microSeconds();a.method.onMessage(a._state,null,b)}}}(0,ap.default)(aE,"_pubkey",!0);var aJ=a.i(95851);class aK{constructor(a,b={}){(0,ap.default)(this,"name",void 0),(0,ap.default)(this,"options",void 0),(0,ap.default)(this,"closed",void 0),(0,ap.default)(this,"onML",void 0),(0,ap.default)(this,"methodPriority",void 0),(0,ap.default)(this,"channels",void 0),(0,ap.default)(this,"listeners",void 0),(0,ap.default)(this,"processedNonces",void 0),(0,ap.default)(this,"nonce",void 0),this.name=a,this.options=b,this.closed=!1,this.onML=null,this.methodPriority=[R,F,ab],this.channels=new Map,this.listeners=new Set,this.processedNonces=new Set,this.nonce=0,this.initChannels()}set onmessage(a){this.removeEventListener("message",this.onML),a&&"function"==typeof a?(this.onML=a,this.addEventListener("message",a)):this.onML=null}initChannels(){if(this.options.type===aq&&(this.methodPriority=[aq]),this.methodPriority.forEach(a=>{try{let b=new aE(this.name,(0,aJ.default)((0,aJ.default)({},this.options),{},{type:a}));this.channels.set(a,b),i.debug(`Succeeded to initialize ${a} method in channel ${this.name}`),b.onmessage=a=>this.handleMessage(a)}catch(b){i.warn(`Failed to initialize ${a} method in channel ${this.name}: ${b instanceof Error?b.message:String(b)}`)}}),0===this.channels.size)throw Error("Failed to initialize any communication method")}allChannels(){return Array.from(this.channels.keys())}hasChannel(a){return this.channels.has(a)}handleMessage(a){if(a&&a.nonce&&!this.processedNonces.has(a.nonce)){if(this.processedNonces.add(a.nonce),this.processedNonces.size>1e3){let a=Array.from(this.processedNonces).sort()[0];this.processedNonces.delete(a)}this.listeners.forEach(b=>{b(a.message)})}}async postMessage(a){if(this.closed)throw Error(`AdaptiveBroadcastChannel.postMessage(): Cannot post message after channel has closed ${JSON.stringify(a)}`);let b={nonce:this.generateNonce(),message:a},c=Array.from(this.channels.entries()).map(([a,c])=>c.postMessage(b).catch(b=>{throw i.warn(`Failed to send via ${a}: ${b.message}`),b}));if(!(await Promise.allSettled(c)).some(a=>"fulfilled"===a.status))throw Error("Failed to send message through any method");return a}generateNonce(){return`${Date.now()}-${this.nonce++}`}addEventListener(a,b){this.listeners.add(b)}removeEventListener(a,b){this.listeners.delete(b)}async close(){if(this.closed)return;this.onML=null;let a=[];for(let b of this.channels.values())a.push(b.close());await Promise.all(a),this.channels.clear(),this.listeners.clear(),this.closed=!0}}a.s(["BroadcastChannel",()=>aE,"IndexedDbMethod",0,E,"LocalstorageMethod",0,Q,"NativeMethod",0,Y,"OPEN_BROADCAST_CHANNELS",()=>aC,"RedundantAdaptiveBroadcastChannel",()=>aK,"ServerMethod",0,ao,"chooseMethod",()=>aA,"enforceOptions",()=>aB],15133)}];

//# sourceMappingURL=ce191_%40toruslabs_broadcast-channel_dist_lib_esm_index_42ebb11a.js.map