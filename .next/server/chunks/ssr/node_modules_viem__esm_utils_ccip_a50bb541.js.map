{"version":3,"sources":["../../../../node_modules/viem/utils/ccip.ts","../../../../node_modules/viem/errors/ccip.ts"],"sourcesContent":["import type { Abi, Address } from 'abitype'\n\nimport { type CallParameters, call } from '../actions/public/call.js'\nimport type { Client } from '../clients/createClient.js'\nimport type { Transport } from '../clients/transports/createTransport.js'\nimport type { BaseError } from '../errors/base.js'\nimport {\n  OffchainLookupError,\n  type OffchainLookupErrorType as OffchainLookupErrorType_,\n  OffchainLookupResponseMalformedError,\n  type OffchainLookupResponseMalformedErrorType,\n  OffchainLookupSenderMismatchError,\n} from '../errors/ccip.js'\nimport {\n  HttpRequestError,\n  type HttpRequestErrorType,\n} from '../errors/request.js'\nimport type { ErrorType } from '../errors/utils.js'\nimport type { Chain } from '../types/chain.js'\nimport type { Hex } from '../types/misc.js'\nimport { decodeErrorResult } from './abi/decodeErrorResult.js'\nimport { encodeAbiParameters } from './abi/encodeAbiParameters.js'\nimport { isAddressEqual } from './address/isAddressEqual.js'\nimport { concat } from './data/concat.js'\nimport { isHex } from './data/isHex.js'\nimport {\n  localBatchGatewayRequest,\n  localBatchGatewayUrl,\n} from './ens/localBatchGatewayRequest.js'\nimport { stringify } from './stringify.js'\n\nexport const offchainLookupSignature = '0x556f1830'\nexport const offchainLookupAbiItem = {\n  name: 'OffchainLookup',\n  type: 'error',\n  inputs: [\n    {\n      name: 'sender',\n      type: 'address',\n    },\n    {\n      name: 'urls',\n      type: 'string[]',\n    },\n    {\n      name: 'callData',\n      type: 'bytes',\n    },\n    {\n      name: 'callbackFunction',\n      type: 'bytes4',\n    },\n    {\n      name: 'extraData',\n      type: 'bytes',\n    },\n  ],\n} as const satisfies Abi[number]\n\nexport type OffchainLookupErrorType = OffchainLookupErrorType_ | ErrorType\n\nexport async function offchainLookup<chain extends Chain | undefined>(\n  client: Client<Transport, chain>,\n  {\n    blockNumber,\n    blockTag,\n    data,\n    to,\n  }: Pick<CallParameters, 'blockNumber' | 'blockTag'> & {\n    data: Hex\n    to: Address\n  },\n): Promise<Hex> {\n  const { args } = decodeErrorResult({\n    data,\n    abi: [offchainLookupAbiItem],\n  })\n  const [sender, urls, callData, callbackSelector, extraData] = args\n\n  const { ccipRead } = client\n  const ccipRequest_ =\n    ccipRead && typeof ccipRead?.request === 'function'\n      ? ccipRead.request\n      : ccipRequest\n\n  try {\n    if (!isAddressEqual(to, sender))\n      throw new OffchainLookupSenderMismatchError({ sender, to })\n\n    const result = urls.includes(localBatchGatewayUrl)\n      ? await localBatchGatewayRequest({\n          data: callData,\n          ccipRequest: ccipRequest_,\n        })\n      : await ccipRequest_({ data: callData, sender, urls })\n\n    const { data: data_ } = await call(client, {\n      blockNumber,\n      blockTag,\n      data: concat([\n        callbackSelector,\n        encodeAbiParameters(\n          [{ type: 'bytes' }, { type: 'bytes' }],\n          [result, extraData],\n        ),\n      ]),\n      to,\n    } as CallParameters)\n\n    return data_!\n  } catch (err) {\n    throw new OffchainLookupError({\n      callbackSelector,\n      cause: err as BaseError,\n      data,\n      extraData,\n      sender,\n      urls,\n    })\n  }\n}\n\nexport type CcipRequestParameters = {\n  data: Hex\n  sender: Address\n  urls: readonly string[]\n}\n\nexport type CcipRequestReturnType = Hex\n\nexport type CcipRequestErrorType =\n  | HttpRequestErrorType\n  | OffchainLookupResponseMalformedErrorType\n  | ErrorType\n\nexport async function ccipRequest({\n  data,\n  sender,\n  urls,\n}: CcipRequestParameters): Promise<CcipRequestReturnType> {\n  let error = new Error('An unknown error occurred.')\n\n  for (let i = 0; i < urls.length; i++) {\n    const url = urls[i]\n    const method = url.includes('{data}') ? 'GET' : 'POST'\n    const body = method === 'POST' ? { data, sender } : undefined\n    const headers: HeadersInit =\n      method === 'POST' ? { 'Content-Type': 'application/json' } : {}\n\n    try {\n      const response = await fetch(\n        url.replace('{sender}', sender.toLowerCase()).replace('{data}', data),\n        {\n          body: JSON.stringify(body),\n          headers,\n          method,\n        },\n      )\n\n      let result: any\n      if (\n        response.headers.get('Content-Type')?.startsWith('application/json')\n      ) {\n        result = (await response.json()).data\n      } else {\n        result = (await response.text()) as any\n      }\n\n      if (!response.ok) {\n        error = new HttpRequestError({\n          body,\n          details: result?.error\n            ? stringify(result.error)\n            : response.statusText,\n          headers: response.headers,\n          status: response.status,\n          url,\n        })\n        continue\n      }\n\n      if (!isHex(result)) {\n        error = new OffchainLookupResponseMalformedError({\n          result,\n          url,\n        })\n        continue\n      }\n\n      return result\n    } catch (err) {\n      error = new HttpRequestError({\n        body,\n        details: (err as Error).message,\n        url,\n      })\n    }\n  }\n\n  throw error\n}\n","import type { Address } from 'abitype'\n\nimport type { Hex } from '../types/misc.js'\nimport { stringify } from '../utils/stringify.js'\n\nimport { BaseError } from './base.js'\nimport { getUrl } from './utils.js'\n\nexport type OffchainLookupErrorType = OffchainLookupError & {\n  name: 'OffchainLookupError'\n}\nexport class OffchainLookupError extends BaseError {\n  constructor({\n    callbackSelector,\n    cause,\n    data,\n    extraData,\n    sender,\n    urls,\n  }: {\n    callbackSelector: Hex\n    cause: BaseError\n    data: Hex\n    extraData: Hex\n    sender: Address\n    urls: readonly string[]\n  }) {\n    super(\n      cause.shortMessage ||\n        'An error occurred while fetching for an offchain result.',\n      {\n        cause,\n        metaMessages: [\n          ...(cause.metaMessages || []),\n          cause.metaMessages?.length ? '' : [],\n          'Offchain Gateway Call:',\n          urls && [\n            '  Gateway URL(s):',\n            ...urls.map((url) => `    ${getUrl(url)}`),\n          ],\n          `  Sender: ${sender}`,\n          `  Data: ${data}`,\n          `  Callback selector: ${callbackSelector}`,\n          `  Extra data: ${extraData}`,\n        ].flat(),\n        name: 'OffchainLookupError',\n      },\n    )\n  }\n}\n\nexport type OffchainLookupResponseMalformedErrorType =\n  OffchainLookupResponseMalformedError & {\n    name: 'OffchainLookupResponseMalformedError'\n  }\nexport class OffchainLookupResponseMalformedError extends BaseError {\n  constructor({ result, url }: { result: any; url: string }) {\n    super(\n      'Offchain gateway response is malformed. Response data must be a hex value.',\n      {\n        metaMessages: [\n          `Gateway URL: ${getUrl(url)}`,\n          `Response: ${stringify(result)}`,\n        ],\n        name: 'OffchainLookupResponseMalformedError',\n      },\n    )\n  }\n}\n\n/** @internal */\nexport type OffchainLookupSenderMismatchErrorType =\n  OffchainLookupSenderMismatchError & {\n    name: 'OffchainLookupSenderMismatchError'\n  }\nexport class OffchainLookupSenderMismatchError extends BaseError {\n  constructor({ sender, to }: { sender: Address; to: Address }) {\n    super(\n      'Reverted sender address does not match target contract address (`to`).',\n      {\n        metaMessages: [\n          `Contract address: ${to}`,\n          `OffchainLookup sender address: ${sender}`,\n        ],\n        name: 'OffchainLookupSenderMismatchError',\n      },\n    )\n  }\n}\n"],"names":[],"mappings":"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","ignoreList":[0,1]}