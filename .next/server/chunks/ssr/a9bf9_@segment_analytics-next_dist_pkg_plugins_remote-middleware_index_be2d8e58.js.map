{"version":3,"sources":["../../../../node_modules/%40segment/analytics-next/src/plugins/remote-middleware/index.ts"],"sourcesContent":["import { CDNSettings } from '../../browser'\nimport { Context } from '../../core/context'\nimport { isServer } from '../../core/environment'\nimport { loadScript } from '../../lib/load-script'\nimport { getNextIntegrationsURL } from '../../lib/parse-cdn'\nimport { MiddlewareFunction } from '../middleware'\n\nexport async function remoteMiddlewares(\n  ctx: Context,\n  settings: CDNSettings,\n  obfuscate?: boolean\n): Promise<MiddlewareFunction[]> {\n  if (isServer()) {\n    return []\n  }\n  const path = getNextIntegrationsURL()\n  const remoteMiddleware = settings.enabledMiddleware ?? {}\n  const names = Object.entries(remoteMiddleware)\n    .filter(([_, enabled]) => enabled)\n    .map(([name]) => name)\n\n  const scripts = names.map(async (name) => {\n    const nonNamespaced = name.replace('@segment/', '')\n    let bundleName = nonNamespaced\n    if (obfuscate) {\n      bundleName = btoa(nonNamespaced).replace(/=/g, '')\n    }\n    const fullPath = `${path}/middleware/${bundleName}/latest/${bundleName}.js.gz`\n\n    try {\n      await loadScript(fullPath)\n      // @ts-ignore\n      return window[`${nonNamespaced}Middleware`] as MiddlewareFunction\n    } catch (error: any) {\n      ctx.log('error', error)\n      ctx.stats.increment('failed_remote_middleware')\n    }\n  })\n\n  let middleware = await Promise.all(scripts)\n  middleware = middleware.filter(Boolean)\n\n  return middleware as MiddlewareFunction[]\n}\n"],"names":[],"mappings":"wDAEA,EAAyB,CAAlB,CAA0C,CAAA,AAAxC,CAAwC,CAAA,MACjD,AADiB,EAAE,AACQ,CAApB,CAA2C,CAAzC,AAAyC,CAAA,CAAA,CADzB,AACyB,KAClD,EADmB,AACoB,CAAhC,CADc,AACuC,CAAnD,AAAmD,CAAA,IADjC,GAIrB,IAHsD,CAAA,IAGtC,EACpB,CAAY,CACZ,CAAqB,AALQ,CAM7B,CAAmB,AANY,MAAM,IAGA,+HAKrC,GAAA,CAAA,EAAI,EAAA,QAAA,AAAQ,EAAE,EACZ,CADc,KACd,CAAA,EAAA,AAAO,EAAE,CAAA,CA0BM,AA1BN,IAAT,GAEI,EAAI,CAAA,CAAA,CAAG,EAAA,sBAAA,AAAsB,EAAE,CAAA,CAwBpB,CAAA,EAAA,AAAM,OAAN,AAAa,CAAC,GAAG,CAtBpB,AAIE,AAkBmB,KAlBd,CAJD,CAAC,AAsBqB,CAAC,MAtBf,CADH,AACI,OADJ,EAAA,EAAS,KACW,CAAC,AADb,WAAC,AAAiB,EAAA,EAAI,CAAA,CAAE,AAAN,CAAM,CAEtD,MAFgD,AAE1C,CAAC,MAFyC,GAExC,CAAY,CAF4B,CAEvB,OAAA,AAAf,CAAA,CAAA,EAAA,CAAS,CAAA,AAAP,CAAO,AAAa,EAAb,AAAM,CAAO,CAAC,CACjC,CADmB,EAChB,CAAC,SAAC,CAAM,EAAK,OAAA,AAAN,CAAA,CAAA,EAAU,AAAV,AAAM,CAAI,CAAC,CAAA,AAEF,GAAG,CAAC,SAAO,CAAI,EAAA,MAAA,CAAA,EAAA,EAAA,SAAA,EAAA,EAAA,KAAA,EAAA,KAAA,EAAA,uFAE/B,EADE,EAAgB,EAAK,EAAD,EACZ,GADoB,AACjB,CADkB,CAAhB,UAA2B,CAAE,AAClB,CAAA,CADoB,CAAC,CAAA,AAE/C,IACF,EAAa,GADF,CACM,CAAC,AADL,GACoB,AAAvB,OAA8B,CAAC,EAAV,CAAC,CAAa,CAAE,GAAE,CAAC,CAAA,AAE9C,EAAW,GAAA,GAAH,GAAG,CAAG,EAAI,EAAA,cAAA,MAAA,CAAe,EAAU,QAAA,IAAA,MAAA,CAAW,EAAU,QAAA,CAAQ,CAAA,iBAG5E,6BAAA,CAAA,EAAA,GAAM,EAAA,EAAN,QAAM,AAAU,EAAC,IAAS,IAAD,CAAC,EAE1B,OAFA,EAAA,IAAA,EAA0B,CAE1B,AAF0B,CAE1B,EAAA,AAAO,MAAM,CAAC,CAAd,EAAc,MAAA,CAAG,EAAa,WAAA,EAAY,CAAuB,CAAA,CAAA,yBAEjE,EAAI,CAAD,EAAI,CAAC,OAAO,CAAE,GACjB,EAAI,CAAD,CADmB,CAAC,CAAA,CACd,CAAC,SAAS,CAAC,0BAA0B,CAAC,CAAA,4BAElD,CAAC,CAAA,CAEyC,CAAA,OAG3C,MAAA,CAAA,EAFa,AADI,AAGjB,EAHiB,IAAA,EAA0B,AAG3C,CAFwB,CAAD,KAAO,CAAC,OAAO,CAAC,CAAA,AAEE,CAAA,KAC1C"}